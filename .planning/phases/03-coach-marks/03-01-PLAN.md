---
phase: 03-coach-marks
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/onboarding/tour.ts
  - src/components/onboarding/index.ts
  - src/components/onboarding/driver-overrides.css
autonomous: true

must_haves:
  truths:
    - "On desktop, startTour() highlights course search sidebar, calendar, schedule tabs, exams toggle, export buttons, and dark mode toggle with spotlight overlay"
    - "On mobile (viewport < 1024px), startTour() highlights mobile add FAB, calendar, schedule tabs, exams toggle, export buttons, and dark mode toggle, skipping desktop-only course search"
    - "Each tour step shows a Persian progress indicator with Persian digits (e.g., '۲ از ۵') and Next/Previous/Done buttons with Persian labels"
    - "User can dismiss the tour at any step via close button or Escape key"
    - "Tour popovers remain within viewport on narrow mobile screens without clipping"
    - "Tour completion fires the onComplete callback (used by Phase 4 to set onboardingCompletedAtom)"
  artifacts:
    - path: "src/components/onboarding/tour.ts"
      provides: "startTour(onComplete?) function that configures and launches driver.js tour"
      exports: ["startTour"]
    - path: "src/components/onboarding/index.ts"
      provides: "Barrel export including startTour"
      exports: ["startTour", "tourSteps", "TourStepDef"]
    - path: "src/components/onboarding/driver-overrides.css"
      provides: "Mobile viewport safety CSS for popover max-width on narrow screens"
      contains: "max-width: calc(100vw - 24px)"
  key_links:
    - from: "src/components/onboarding/tour.ts"
      to: "src/components/onboarding/steps.ts"
      via: "import { tourSteps } from './steps'"
      pattern: "import.*tourSteps.*from.*steps"
    - from: "src/components/onboarding/tour.ts"
      to: "src/utils/persian.ts"
      via: "import { toPersianDigits } from '@/utils/persian'"
      pattern: "toPersianDigits"
    - from: "src/components/onboarding/tour.ts"
      to: "driver.js"
      via: "import { driver } from 'driver.js'"
      pattern: "import.*driver.*from.*driver.js"
    - from: "src/components/onboarding/index.ts"
      to: "src/components/onboarding/tour.ts"
      via: "export { startTour } from './tour'"
      pattern: "export.*startTour.*from.*tour"
---

<objective>
Create the `startTour()` function that configures and launches a driver.js guided tour with device-aware step filtering, Persian UI labels, and Persian digit progress indicators.

Purpose: This is the core tour engine for Phase 3. Once complete, any caller (Phase 2's WelcomeModal or Phase 4's help button) can invoke `startTour(onComplete)` to launch the interactive walkthrough.

Output: `src/components/onboarding/tour.ts` exporting `startTour`, updated barrel export, and mobile viewport CSS safety net.
</objective>

<execution_context>
@/home/erfan/.claude/get-shit-done/workflows/execute-plan.md
@/home/erfan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-coach-marks/03-RESEARCH.md

@src/components/onboarding/steps.ts
@src/components/onboarding/index.ts
@src/components/onboarding/driver-overrides.css
@src/utils/persian.ts
@src/atoms/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create startTour function and update barrel export</name>
  <files>src/components/onboarding/tour.ts, src/components/onboarding/index.ts</files>
  <action>
Create `src/components/onboarding/tour.ts` with the following implementation:

1. **Imports:**
   - `import { driver } from 'driver.js'` (named import of the factory function)
   - `import { tourSteps } from './steps'` (step definitions from Phase 1)
   - `import { toPersianDigits } from '@/utils/persian'` (digit conversion utility)

2. **`isMobile()` helper** (not exported):
   - Returns `window.innerWidth < 1024` (matches Tailwind `lg:` breakpoint)
   - MUST be called at tour launch time, NOT at module load time (users may resize/rotate)

3. **`startTour(onComplete?: () => void): void` function** (exported):
   - Filter `tourSteps` by device: keep steps where `device === 'both'` OR (`device === 'mobile'` when mobile) OR (`device === 'desktop'` when not mobile)
   - Map filtered `TourStepDef[]` to driver.js `DriveStep[]` format:
     ```
     { element: step.targetSelector, popover: { title: step.title, description: step.description, side: step.side, align: step.align } }
     ```
   - Create driver instance with these exact config values:
     - `steps`: the mapped DriveStep array
     - `showProgress: true`
     - `progressText: '{{current}} از {{total}}'`
     - `nextBtnText: 'بعدی'`
     - `prevBtnText: 'قبلی'`
     - `doneBtnText: 'پایان'`
     - `allowClose: true` (enables close button + Escape key dismissal)
     - `allowKeyboardControl: true`
     - `animate: true`
     - `smoothScroll: true`
     - `overlayOpacity: 0.5`
     - `stagePadding: 8`
     - `stageRadius: 8`
     - `popoverOffset: 12`
     - `showButtons: ['next', 'previous', 'close']`
     - `onPopoverRender: (popover) => { popover.progress.textContent = toPersianDigits(popover.progress.textContent || ''); }` -- converts Western digits to Persian in progress indicator
     - `onDestroyed: () => { onComplete?.(); }` -- fires completion callback when tour finishes or is dismissed
   - Call `driverInstance.drive()` to start the tour

   Do NOT use `onNextClick` or `onPrevClick` overrides -- let driver.js handle navigation with defaults.
   Do NOT wrap in useEffect or any React lifecycle -- this is an imperative function called from event handlers.

4. **Update `src/components/onboarding/index.ts`:**
   - Add `export { startTour } from './tour';` to the existing barrel exports
  </action>
  <verify>
Run `npx tsc --noEmit` -- should pass with no type errors. Verify the tour.ts file imports are resolvable and the exported function signature matches `startTour(onComplete?: () => void): void`.
  </verify>
  <done>
`src/components/onboarding/tour.ts` exists with exported `startTour` function. `src/components/onboarding/index.ts` re-exports `startTour`. TypeScript compilation passes. The function filters steps by device, configures driver.js with Persian labels and progress text, converts digits via `onPopoverRender`, and calls `onComplete` via `onDestroyed`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add mobile viewport CSS safety and verify build</name>
  <files>src/components/onboarding/driver-overrides.css</files>
  <action>
1. **Append mobile viewport CSS to `src/components/onboarding/driver-overrides.css`:**
   Add at the end of the file:
   ```css
   /* ─── Mobile viewport safety ─── */
   @media (max-width: 480px) {
     .driver-popover {
       max-width: calc(100vw - 24px);
     }
   }
   ```
   This prevents popover clipping on narrow mobile screens (< 480px) by constraining the popover width to viewport minus 24px margin.

2. **Run full build** to verify everything compiles and bundles correctly:
   - `npm run build` (runs `tsc -b && vite build`)
   - Confirm no TypeScript errors and no Vite bundling errors
   - Confirm driver.js is included in the bundle (it was already a dependency from Phase 1)
  </action>
  <verify>
`npm run build` completes successfully with exit code 0. Inspect the CSS file to confirm the mobile media query is present. Run `npx tsc --noEmit` as a secondary check.
  </verify>
  <done>
Mobile viewport CSS safety net added to `driver-overrides.css`. Full production build (`npm run build`) passes with no errors. The complete Phase 3 deliverable -- `startTour()` function with device filtering, Persian labels, Persian digit progress, Escape dismissal, and mobile-safe popovers -- is ready for integration by Phase 4.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm run build` passes with no errors
3. `src/components/onboarding/tour.ts` exports `startTour`
4. `src/components/onboarding/index.ts` re-exports `startTour`, `tourSteps`, `TourStepDef`
5. `src/components/onboarding/driver-overrides.css` includes `@media (max-width: 480px)` rule
6. Tour step filtering logic: desktop path includes `course-search` but not `mobile-add`; mobile path includes `mobile-add` but not `course-search`; both paths include `calendar`, `schedule-tabs`, `exams-toggle`, `export-buttons`, `dark-mode`
</verification>

<success_criteria>
- `startTour()` can be called imperatively and launches a driver.js tour with device-appropriate steps
- Progress indicator shows Persian digits (via onPopoverRender + toPersianDigits)
- Navigation buttons show Persian labels (بعدی, قبلی, پایان)
- Tour is dismissible via close button and Escape key (allowClose: true)
- Popovers don't clip on mobile viewports (CSS max-width constraint)
- onComplete callback fires when tour finishes or is dismissed
- Full build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-coach-marks/03-01-SUMMARY.md`
</output>
