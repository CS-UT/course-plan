---
phase: 04-integration-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/App.tsx, src/components/onboarding/WelcomeModal.tsx]
autonomous: false

must_haves:
  truths:
    - "Clicking 'Start Tour' in WelcomeModal launches the driver.js coach marks tour"
    - "A '?' help button is visible in the header on all screen sizes"
    - "Clicking the '?' help button launches the coach marks tour for any user at any time"
    - "A returning user (localStorage flag set) never sees the welcome modal on page load"
    - "JPG export produces a clean image with no onboarding overlays or popovers"
  artifacts:
    - path: "src/App.tsx"
      provides: "startTour import, wired handleStartTour, help button in header"
      contains: "startTour"
    - path: "src/components/onboarding/WelcomeModal.tsx"
      provides: "Defensive data-export-exclude attribute on root div"
      contains: "data-export-exclude"
  key_links:
    - from: "src/App.tsx"
      to: "src/components/onboarding/index.ts"
      via: "named import of startTour"
      pattern: "import.*startTour.*from.*@/components/onboarding"
    - from: "src/App.tsx handleStartTour()"
      to: "src/components/onboarding/tour.ts startTour()"
      via: "direct function call"
      pattern: "function handleStartTour.*startTour\\(\\)"
    - from: "header help button onClick"
      to: "startTour()"
      via: "inline onClick handler"
      pattern: "onClick=.*startTour"
---

<objective>
Wire the WelcomeModal's onStartTour callback to the real startTour() function, add a "?" help button to the header for relaunching the tour, and add a defensive data-export-exclude attribute to the WelcomeModal.

Purpose: Complete the end-to-end onboarding flow so first-time users experience welcome -> tour, returning users see nothing, and any user can relaunch the tour via the help button.
Output: Modified App.tsx with wired tour, help button; modified WelcomeModal.tsx with export-exclude attribute.
</objective>

<execution_context>
@/home/erfan/.claude/get-shit-done/workflows/execute-plan.md
@/home/erfan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-integration-polish/04-RESEARCH.md
@src/App.tsx
@src/components/onboarding/index.ts
@src/components/onboarding/WelcomeModal.tsx
@src/components/onboarding/tour.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire startTour and add help button in App.tsx, add export-exclude to WelcomeModal</name>
  <files>src/App.tsx, src/components/onboarding/WelcomeModal.tsx</files>
  <action>
Three changes in src/App.tsx:

1. **Update import** (line 10): Change `import { WelcomeModal } from '@/components/onboarding'` to `import { WelcomeModal, startTour } from '@/components/onboarding'`.

2. **Wire handleStartTour** (lines 87-89): Replace the console.log placeholder with a call to startTour():
```typescript
function handleStartTour() {
  startTour();
}
```
Do NOT pass an onComplete callback -- the WelcomeModal already sets onboardingCompletedAtom to true before calling onStartTour. See Phase 3 decision: "onDestroyed hook fires onComplete for both tour completion and dismissal."

3. **Add "?" help button** in the header button group (the `<div className="flex items-center gap-2 sm:gap-3 mr-auto sm:mr-0">` at line 99). Place it between the GitHub link (ends at line 111) and the dark mode toggle (starts at line 112). Use this exact JSX:
```tsx
<button
  onClick={() => startTour()}
  className="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors cursor-pointer text-gray-600 dark:text-gray-300"
  title="راهنمای استفاده"
>
  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    <circle cx="12" cy="12" r="10"/>
    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
    <line x1="12" y1="17" x2="12.01" y2="17"/>
  </svg>
</button>
```
The className is copied from the dark mode toggle button. The SVG is the Lucide "help-circle" icon at 18x18. The title is Persian for "Usage guide." Place it OUTSIDE the `hidden sm:block` wrapper so it is visible on all screen sizes (see Pitfall 2 from research).

One change in src/components/onboarding/WelcomeModal.tsx:

4. **Add data-export-exclude** to the root div of WelcomeModal as a defensive safety net. Find the root div with `className="fixed inset-0 z-50..."` and add `data-export-exclude` attribute. This is belt-and-suspenders -- the modal is outside #schedule-export-area so html-to-image already excludes it, but this matches the established pattern (used in WeeklySchedule.tsx lines 174, 188, 203).
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no type errors. Run `npm run build` to verify production build succeeds. Grep for the following patterns to confirm changes:
- `grep "startTour" src/App.tsx` should show import and two usages (handleStartTour body + help button onClick)
- `grep "راهنمای استفاده" src/App.tsx` should show the help button title
- `grep "data-export-exclude" src/components/onboarding/WelcomeModal.tsx` should show the attribute
- `grep "console.log.*Tour" src/App.tsx` should return NO matches (placeholder removed)
  </verify>
  <done>
handleStartTour calls startTour() instead of console.log. "?" help button visible in header between GitHub link and dark mode toggle. WelcomeModal root div has data-export-exclude attribute. TypeScript compiles and production build succeeds.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify end-to-end onboarding flow</name>
  <files>src/App.tsx, src/components/onboarding/WelcomeModal.tsx</files>
  <action>
Human verification of the complete onboarding integration. Run `npm run dev` to start the dev server, then verify all five scenarios below in the browser.

What was built: Complete onboarding integration -- WelcomeModal triggers real tour, help button relaunches tour, export produces clean images.

Verification steps:

1. **First-time user flow:** Open browser DevTools -> Application -> Local Storage -> delete `plan-onboarding-v1` key. Reload the page.
   - Expected: WelcomeModal appears with carousel slides
   - Click "Start Tour" -> modal dismisses, driver.js tour starts with spotlight overlay
   - Complete or dismiss the tour

2. **Returning user flow:** Reload the page (do NOT clear localStorage).
   - Expected: No WelcomeModal appears. Page loads normally.

3. **Help button:** Look for a "?" icon button in the header (between GitHub icon and dark/light mode toggle).
   - Expected: Button is visible on both desktop and mobile viewports
   - Click it -> driver.js tour starts immediately

4. **Export clean image:** While the tour is NOT running, click the JPG download button.
   - Expected: Downloaded image shows only the schedule grid, no onboarding artifacts

5. **Dark mode:** Toggle dark mode, then click "?" help button.
   - Expected: Tour popovers render correctly in dark mode (dark background, light text, RTL layout)
  </action>
  <verify>User confirms all 5 scenarios pass by typing "approved"</verify>
  <done>All five verification scenarios pass: first-time flow, returning user flow, help button, clean export, dark mode tour.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` succeeds
3. `startTour` is imported and used in App.tsx (not just console.log placeholder)
4. Help button renders in header on all viewport sizes
5. WelcomeModal has data-export-exclude attribute
6. No regressions in existing functionality
</verification>

<success_criteria>
- First-time visitor sees WelcomeModal → clicking "Start Tour" launches driver.js tour
- Returning visitor sees no modal on page load
- "?" help button visible in header, clicking it launches tour anytime
- JPG export produces clean image with no onboarding artifacts
- All changes compile without errors and build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/04-integration-polish/04-01-SUMMARY.md`
</output>
